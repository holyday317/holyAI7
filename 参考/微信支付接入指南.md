# 微信网页支付接入指南

## 一、开通条件

### 1. 微信商户平台账号
- **营业执照**：个体工商户或企业营业执照
- **组织机构代码证**或**统一社会信用代码证**
- **法人身份证**：正反面照片
- **银行账户信息**：对公账户或法人个人账户
- **商户门头照片**：实际经营场所照片

### 2. 资质要求
- **企业/个体户**：必须有合法的营业执照
- **经营范围**：经营范围需包含实际业务内容
- **特殊行业**：如教育、医疗等需要额外资质证明

### 3. 费用说明
- **入驻费**：目前免费（2024年政策）
- **交易手续费**：0.6%（每笔交易）
- **结算周期**：T+1（工作日次日结算）

### 4. 审核时间
- **资料审核**：1-3个工作日
- **账号激活**：审核通过后即可使用

---

## 二、接入步骤

### 步骤1：注册微信商户平台
1. 访问 [https://pay.weixin.qq.com](https://pay.weixin.qq.com)
2. 点击"立即接入"
3. 填写商户基本信息
4. 上传营业执照等资质文件
5. 提交审核

### 步骤2：获取支付参数
审核通过后，在商户平台获取以下信息：
- **商户号（mch_id）**
- **API密钥（API Key）**：需要在商户平台设置
- **API证书**：下载 apiclient_cert.pem 和 apiclient_key.pem
- **AppID**：如果是微信公众号支付，需要微信公众平台的 AppID

### 步骤3：配置产品权限
在商户平台开通以下产品：
- **JSAPI支付**：公众号内支付
- **H5支付**：手机浏览器支付
- **Native支付**：扫码支付（可选）
- **小程序支付**：小程序内支付（可选）

---

## 三、技术实现

### 1. 安装依赖包

```bash
cd holy7-express
npm install wechatpay-node-v3 axios
```

### 2. 配置支付参数

创建配置文件 `config/wechatpay.js`：

```javascript
module.exports = {
  // 商户号
  mchid: process.env.WECHAT_MCH_ID,
  
  // 商户API私钥
  privateKey: process.env.WECHAT_PRIVATE_KEY,
  
  // 商户API证书序列号
  serialNo: process.env.WECHAT_SERIAL_NO,
  
  // 微信支付平台证书
  platformCert: process.env.WECHAT_PLATFORM_CERT,
  
  // AppID
  appid: process.env.WECHAT_APPID,
  
  // API地址
  apis: {
    v3: 'https://api.mch.weixin.qq.com',
  },
  
  // 通知URL
  notifyUrl: process.env.WECHAT_NOTIFY_URL,
};
```

### 3. 创建支付服务

创建 `services/wechatpayService.js`：

```javascript
const { Wechatpay, Formatter } = require('wechatpay-node-v3');
const config = require('../config/wechatpay');

// 初始化微信支付
const pay = new Wechatpay({
  appid: config.appid,
  mchid: config.mchid,
  public_key: config.platformCert,
  private_key: config.privateKey,
});

class WechatPayService {
  /**
   * 创建JSAPI支付订单
   */
  static async createJsapiOrder(orderData) {
    const { 
      openid, // 用户openid（需要从微信获取）
      description, // 商品描述
      outTradeNo, // 商户订单号
      totalFee, // 总金额（分）
    } = orderData;

    try {
      const result = await pay.transactions_jsapi({
        description,
        out_trade_no: outTradeNo,
        notify_url: config.notifyUrl,
        amount: {
          total: totalFee,
          currency: 'CNY',
        },
        payer: {
          openid,
        },
      });

      return {
        prepay_id: result.prepay_id,
        // 需要返回给前端的参数
        paySign: this.generatePaySign(result.prepay_id),
      };
    } catch (error) {
      throw new Error(`创建支付订单失败: ${error.message}`);
    }
  }

  /**
   * 创建H5支付订单
   */
  static async createH5Order(orderData) {
    const { 
      description, 
      outTradeNo, 
      totalFee,
      clientIp, // 客户端IP
    } = orderData;

    try {
      const result = await pay.transactions_h5({
        description,
        out_trade_no: outTradeNo,
        notify_url: config.notifyUrl,
        amount: {
          total: totalFee,
          currency: 'CNY',
        },
        scene_info: {
          payer_client_ip: clientIp,
          h5_info: {
            type: 'Wap',
            app_name: 'holy7',
            app_url: process.env.FRONTEND_URL,
          },
        },
      });

      return {
        h5_url: result.h5_url, // H5支付跳转链接
      };
    } catch (error) {
      throw new Error(`创建H5支付订单失败: ${error.message}`);
    }
  }

  /**
   * 查询订单状态
   */
  static async queryOrder(outTradeNo) {
    try {
      const result = await pay.query({
        out_trade_no: outTradeNo,
      });
      return result;
    } catch (error) {
      throw new Error(`查询订单失败: ${error.message}`);
    }
  }

  /**
   * 关闭订单
   */
  static async closeOrder(outTradeNo) {
    try {
      await pay.close({ out_trade_no: outTradeNo });
      return { success: true };
    } catch (error) {
      throw new Error(`关闭订单失败: ${error.message}`);
    }
  }

  /**
   * 申请退款
   */
  static async refund(refundData) {
    const {
      outTradeNo, // 原订单号
      outRefundNo, // 退款订单号
      totalFee, // 原订单金额
      refundFee, // 退款金额
    } = refundData;

    try {
      const result = await pay.refunds({
        out_trade_no: outTradeNo,
        out_refund_no: outRefundNo,
        notify_url: config.notifyUrl,
        amount: {
          refund: refundFee,
          total: totalFee,
          currency: 'CNY',
        },
      });

      return {
        refund_id: result.refund_id,
        status: result.status,
      };
    } catch (error) {
      throw new Error(`申请退款失败: ${error.message}`);
    }
  }

  /**
   * 验证支付回调签名
   */
  static async verifyNotification(body, signature, timestamp, nonce) {
    try {
      const result = await pay.verify(
        timestamp,
        nonce,
        body,
        signature
      );
      return result;
    } catch (error) {
      throw new Error(`验证签名失败: ${error.message}`);
    }
  }

  /**
   * 生成支付签名（JSAPI支付需要）
   */
  static generatePaySign(prepayId) {
    const timeStamp = Math.floor(Date.now() / 1000).toString();
    const nonceStr = Math.random().toString(36).substr(2, 32);
    const pkg = `prepay_id=${prepayId}`;
    const signType = 'RSA';

    const sign = Formatter.rsa(
      config.appid + '\n' + 
      timeStamp + '\n' + 
      nonceStr + '\n' + 
      pkg + '\n'
    );

    return {
      timeStamp,
      nonceStr,
      package: pkg,
      signType,
      paySign: sign,
    };
  }
}

module.exports = WechatPayService;
```

### 4. 创建支付路由

创建 `routes/paymentRoutes.js`：

```javascript
const express = require('express');
const router = express.Router();
const WechatPayService = require('../services/wechatpayService');
const { v4: uuidv4 } = require('uuid');

// 创建支付订单
router.post('/create', async (req, res) => {
  try {
    const { 
      type, // 'jsapi' 或 'h5'
      amount,
      description,
      openid, // JSAPI支付需要
      clientIp, // H5支付需要
    } = req.body;

    // 生成订单号
    const outTradeNo = uuidv4().replace(/-/g, '');

    // 金额转换为分
    const totalFee = Math.round(amount * 100);

    let result;
    if (type === 'jsapi') {
      result = await WechatPayService.createJsapiOrder({
        openid,
        description,
        outTradeNo,
        totalFee,
      });
    } else if (type === 'h5') {
      result = await WechatPayService.createH5Order({
        description,
        outTradeNo,
        totalFee,
        clientIp,
      });
    } else {
      return res.status(400).json({ 
        success: false, 
        message: '不支持的支付类型' 
      });
    }

    // 保存订单到数据库（需要创建订单表）
    // await Order.create({
    //   order_no: outTradeNo,
    //   amount,
    //   description,
    //   status: 'pending',
    //   type,
    // });

    res.json({
      success: true,
      data: {
        ...result,
        orderNo: outTradeNo,
      },
    });
  } catch (error) {
    console.error('创建支付订单失败:', error);
    res.status(500).json({ 
      success: false, 
      message: error.message 
    });
  }
});

// 查询订单
router.get('/query/:orderNo', async (req, res) => {
  try {
    const { orderNo } = req.params;
    const result = await WechatPayService.queryOrder(orderNo);

    res.json({
      success: true,
      data: result,
    });
  } catch (error) {
    res.status(500).json({ 
      success: false, 
      message: error.message 
    });
  }
});

// 支付回调通知
router.post('/notify', async (req, res) => {
  try {
    const {
      body,
      headers: {
        'wechatpay-timestamp': timestamp,
        'wechatpay-nonce': nonce,
        'wechatpay-signature': signature,
      },
    } = req;

    // 验证签名
    const result = await WechatPayService.verifyNotification(
      JSON.stringify(body),
      signature,
      timestamp,
      nonce
    );

    // 处理支付结果
    if (result.event_type === 'TRANSACTION.SUCCESS') {
      const { out_trade_no, transaction_id, amount } = result.resource;

      // 更新订单状态
      // await Order.updateStatus(out_trade_no, 'paid', {
      //   transactionId: transaction_id,
      //   paidAmount: amount.total / 100,
      // });

      console.log(`订单 ${out_trade_no} 支付成功`);
    }

    res.json({ code: 'SUCCESS', message: '成功' });
  } catch (error) {
    console.error('处理支付回调失败:', error);
    res.status(500).json({ 
      code: 'FAIL', 
      message: error.message 
    });
  }
});

// 申请退款
router.post('/refund', async (req, res) => {
  try {
    const { 
      orderNo,
      refundAmount,
      refundReason,
    } = req.body;

    // 获取订单信息
    // const order = await Order.findByOrderNo(orderNo);
    // if (!order) {
    //   return res.status(404).json({ 
    //     success: false, 
    //     message: '订单不存在' 
    //   });
    // }

    const outRefundNo = uuidv4().replace(/-/g, '');

    const result = await WechatPayService.refund({
      outTradeNo: orderNo,
      outRefundNo,
      totalFee: Math.round(order.amount * 100),
      refundFee: Math.round(refundAmount * 100),
    });

    // 更新订单状态
    // await Order.updateStatus(orderNo, 'refunding', {
    //   refundNo: outRefundNo,
    //   refundAmount,
    //   refundReason,
    // });

    res.json({
      success: true,
      data: result,
    });
  } catch (error) {
    res.status(500).json({ 
      success: false, 
      message: error.message 
    });
  }
});

module.exports = router;
```

### 5. 在主服务器中注册路由

修改 `server.js`：

```javascript
const paymentRoutes = require('./routes/paymentRoutes');

// 注册支付路由
app.use('/api/payment', paymentRoutes);
```

### 6. 配置环境变量

在 `.env.dev` 中添加：

```env
# 微信支付配置
WECHAT_MCH_ID=你的商户号
WECHAT_PRIVATE_KEY=你的API私钥
WECHAT_SERIAL_NO=你的证书序列号
WECHAT_PLATFORM_CERT=微信支付平台证书
WECHAT_APPID=你的AppID
WECHAT_NOTIFY_URL=https://yourdomain.com/api/payment/notify
FRONTEND_URL=https://yourdomain.com
```

---

## 四、前端集成

### 1. 安装依赖

```bash
cd holy7-front
npm install axios
```

### 2. 创建支付API服务

创建 `src/api/payment.js`：

```javascript
import request from '@/utils/request';

/**
 * 创建支付订单
 */
export const createPayment = (data) => {
  return request({
    url: '/payment/create',
    method: 'post',
    data,
  });
};

/**
 * 查询订单状态
 */
export const queryPayment = (orderNo) => {
  return request({
    url: `/payment/query/${orderNo}`,
    method: 'get',
  });
};

/**
 * 申请退款
 */
export const refundPayment = (data) => {
  return request({
    url: '/payment/refund',
    method: 'post',
    data,
  });
};
```

### 3. 创建支付页面组件

创建 `src/components/PaymentDialog.vue`：

```vue
<template>
  <el-dialog
    v-model="dialogVisible"
    title="支付"
    width="500px"
    :close-on-click-modal="false"
  >
    <div v-if="paymentType === 'h5'">
      <p>请完成支付</p>
      <p>订单号：{{ orderNo }}</p>
      <p>金额：¥{{ amount }}</p>
      <el-button type="primary" @click="openH5Pay">
        打开微信支付
      </el-button>
    </div>

    <div v-if="paymentType === 'jsapi'">
      <p>订单号：{{ orderNo }}</p>
      <p>金额：¥{{ amount }}</p>
      <el-button type="primary" @click="callJsapiPay">
        立即支付
      </el-button>
    </div>

    <div v-if="paymentStatus === 'success'">
      <el-result icon="success" title="支付成功" />
    </div>

    <div v-if="paymentStatus === 'failed'">
      <el-result icon="error" title="支付失败" />
    </div>
  </el-dialog>
</template>

<script setup>
import { ref } from 'vue';
import { createPayment, queryPayment } from '@/api/payment';
import { ElMessage } from 'element-plus';

const props = defineProps({
  modelValue: {
    type: Boolean,
    default: false,
  },
  amount: {
    type: Number,
    required: true,
  },
  description: {
    type: String,
    default: '订单支付',
  },
  paymentType: {
    type: String,
    default: 'h5', // 'h5' 或 'jsapi'
  },
});

const emit = defineEmits(['update:modelValue', 'success']);

const dialogVisible = ref(props.modelValue);
const paymentStatus = ref('');
const orderNo = ref('');
const h5Url = ref('');
const jsapiParams = ref({});

// 创建支付订单
const handleCreatePayment = async () => {
  try {
    const res = await createPayment({
      type: props.paymentType,
      amount: props.amount,
      description: props.description,
      clientIp: window.location.hostname,
    });

    if (res.success) {
      orderNo.value = res.data.orderNo;

      if (props.paymentType === 'h5') {
        h5Url.value = res.data.h5_url;
      } else if (props.paymentType === 'jsapi') {
        jsapiParams.value = res.data;
      }
    }
  } catch (error) {
    ElMessage.error('创建支付订单失败');
  }
};

// 打开H5支付
const openH5Pay = () => {
  window.location.href = h5Url.value;
};

// 调用JSAPI支付
const callJsapiPay = () => {
  if (!window.WeixinJSBridge) {
    ElMessage.error('请在微信中打开');
    return;
  }

  window.WeixinJSBridge.invoke(
    'getBrandWCPayRequest',
    jsapiParams.value,
    (res) => {
      if (res.err_msg === 'get_brand_wcpay_request:ok') {
        checkPaymentStatus();
      } else {
        paymentStatus.value = 'failed';
      }
    }
  );
};

// 检查支付状态
const checkPaymentStatus = async () => {
  try {
    const res = await queryPayment(orderNo.value);
    
    if (res.data.trade_state === 'SUCCESS') {
      paymentStatus.value = 'success';
      emit('success', {
        orderNo: orderNo.value,
        amount: props.amount,
      });
    }
  } catch (error) {
    console.error('查询支付状态失败', error);
  }
};

watch(
  () => props.modelValue,
  (val) => {
    dialogVisible.value = val;
    if (val) {
      handleCreatePayment();
    }
  }
);

watch(dialogVisible, (val) => {
  emit('update:modelValue', val);
});
</script>
```

---

## 五、注意事项

### 1. 安全性
- **不要在前端暴露**：API密钥、证书等敏感信息必须保存在服务器端
- **HTTPS必需**：支付相关接口必须使用 HTTPS
- **签名验证**：所有回调必须验证签名
- **幂等性处理**：防止重复处理回调

### 2. 金额处理
- 使用**分**作为单位，避免浮点数精度问题
- 前端展示时转换为元

### 3. 订单管理
- 订单号必须唯一
- 记录完整的订单生命周期
- 设置订单超时时间（建议2小时）

### 4. 回调处理
- 异步处理回调，及时响应
- 处理重复回调
- 记录所有回调日志

### 5. 测试
- 使用微信支付沙箱环境测试
- 测试各种支付状态（成功、失败、退款）
- 测试网络异常情况

---

## 六、常见问题

### Q1: 申请微信支付需要多长时间？
A: 一般 1-3 个工作日，特殊行业可能需要更长时间。

### Q2: 个人可以申请微信支付吗？
A: 目前微信支付不支持个人申请，必须是企业或个体工商户。

### Q3: H5支付和JSAPI支付有什么区别？
A: 
- H5支付：在手机浏览器中使用，会跳转到微信支付页面
- JSAPI支付：在微信公众号或小程序内使用，直接调起微信支付

### Q4: 如何获取用户的openid？
A: 需要通过微信网页授权流程获取，具体参考微信官方文档。

### Q5: 支付回调可以不验证签名吗？
A: 绝对不可以！必须验证签名，否则会有安全风险。

---

## 七、参考资源

- [微信支付官方文档](https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml)
- [微信支付SDK for Node.js](https://github.com/wechatpay-apiv3/wechatpay-node-v3)
- [微信支付沙箱环境](https://pay.weixin.qq.com/wiki/doc/apiv3/open/pay/chapter2_7_3.shtml)
