# 问卷按钮功能测试指南

## 测试概述

本文档提供问卷按钮功能的详细测试步骤和验证方法。

## 测试环境准备

### 1. 启动前端开发服务器

```bash
cd holy7-front
npm run dev
```

### 2. 启动后端服务器

```bash
cd holy7-express
npm start
```

### 3. 访问应用

在浏览器中访问 `http://localhost:5173` (或根据实际端口)

## 测试场景

### 测试场景1: 情绪评估问卷

**测试步骤:**

1. 登录应用
2. 在聊天输入框中发送测试消息:
   ```
   测试:请给我一个情绪评估问卷
   ```
3. AI会返回包含特殊标记的答案:
   ```
   好的,为了了解你当前的情绪状态,请填写以下问卷:
   
   【emotion_assessment|填写情绪评估问卷】
   
   这只需要几分钟时间。
   ```
4. 验证点:
   - [ ] 特殊标记被正确解析,显示为紫色渐变按钮
   - [ ] 按钮文本显示为"填写情绪评估问卷"
   - [ ] 点击按钮后弹出问卷弹窗
   - [ ] 弹窗标题显示"情绪评估"
   - [ ] 弹窗包含6个滑块字段(整体情绪、焦虑、低落、压力、睡眠、精力)
   - [ ] 滑块范围从1到10
   - [ ] 每个滑块都有对应的标签
   - [ ] 调整滑块时数值实时更新
   - [ ] 所有字段填写后"提交"按钮可用
   - [ ] 点击"取消"关闭弹窗
   - [ ] 点击"提交"后弹窗关闭,并在聊天中显示AI回复

**预期结果:**
```
感谢你完成情绪评估问卷！根据你的反馈，我会为你提供更有针对性的建议。你的整体情绪评分是 7 分，我会继续关注你的情绪状态。
```

---

### 测试场景2: 认知记录表

**测试步骤:**

1. 在聊天中发送消息:
   ```
   我想记录一个让我情绪波动的事件
   ```
2. AI返回:
   ```
   好的,我们可以使用认知记录表来帮助你识别和管理自动化思维。
   
   【thought_record|填写认知记录表】
   
   请详细描述当时的情况。
   ```
3. 验证点:
   - [ ] 弹窗标题显示"认知记录表"
   - [ ] 包含6个字段:情境、自动化思维、情绪类型、情绪强度、行为、身体感受
   - [ ] 情绪类型为下拉选择框
   - [ ] 情绪强度为滑块(1-10分)
   - [ ] 其他字段为文本域
   - [ ] 文本域有占位符提示
   - [ ] 表单验证正常,必填项未填写时不能提交

---

### 测试场景3: 活动计划表

**测试步骤:**

1. 在聊天中发送消息:
   ```
   我想制定一个活动计划
   ```
2. AI返回:
   ```
   很好的想法!制定活动计划可以帮助你建立积极的习惯。
   
   【activity_plan|制定活动计划】
   
   我们可以规划接下来几天的活动。
   ```
3. 验证点:
   - [ ] 弹窗包含2个活动(活动1和活动2)
   - [ ] 每个活动包含:活动名称、愉悦感评分、掌控感评分
   - [ ] 活动名称为文本域
   - [ ] 愉悦感和掌控感为滑块(1-10分)
   - [ ] 提交后显示相应的鼓励回复

---

### 测试场景4: 多个问卷按钮

**测试步骤:**

1. 在聊天中发送消息:
   ```
   我需要练习哪些心理技能?
   ```
2. AI返回多个问卷按钮:
   ```
   基于你的需求,我推荐以下练习:
   
   【emotion_assessment|填写情绪评估问卷】
   【thought_record|填写认知记录表】
   【activity_plan|制定活动计划】
   【problem_solving|填写问题解决工作表】
   【mindfulness_breathing|开始正念呼吸练习】
   
   你可以选择其中一项或多项进行练习。
   ```
3. 验证点:
   - [ ] 5个按钮都正确渲染
   - [ ] 按钮水平排列,自动换行
   - [ ] 每个按钮点击都能打开对应的问卷
   - [ ] 按钮样式一致(紫色渐变背景)
   - [ ] 鼠标悬停时有上浮效果

---

### 测试场景5: 特殊标记与Markdown混用

**测试步骤:**

1. 在聊天中发送消息:
   ```
   给我一个结构化的练习指南
   ```
2. AI返回:
   ```
   # 情绪管理练习计划
   
   ## 第一步: 评估
   【emotion_assessment|评估当前情绪】
   
   ## 第二步: 记录
   当遇到情绪波动时:
   【thought_record|填写认知记录表】
   
   ## 第三步: 行动
   【activity_plan|制定活动计划】
   
   ## 第四步: 放松
   【mindfulness_breathing|开始正念练习】
   ```
3. 验证点:
   - [ ] Markdown标题正确渲染
   - [ ] 特殊标记被正确提取
   - [ ] 按钮显示在相应位置
   - [ ] 特殊标记本身不显示在最终文本中
   - [ ] 整体排版美观

---

### 测试场景6: 表单验证

**测试步骤:**

1. 打开任意问卷弹窗
2. 不填写任何字段,直接点击"提交"
3. 验证点:
   - [ ] 提示"请填写完整所有必填项"
   - [ ] 弹窗不会关闭
   - [ ] 数据不会提交

4. 只填写部分字段,点击"提交"
5. 验证点:
   - [ ] 提示"请填写完整所有必填项"
   - [ ] 未填写的字段高亮显示(可选)
   - [ ] 弹窗不会关闭

---

### 测试场景7: 响应式设计

**测试步骤:**

1. 在桌面浏览器(1920x1080)中测试
   - [ ] 问卷弹窗居中显示
   - [ ] 弹窗宽度合适(最大600px)
   - [ ] 按钮排列正常

2. 在平板浏览器(768x1024)中测试
   - [ ] 弹窗自动调整大小
   - [ ] 表单字段布局合理
   - [ ] 按钮大小适中

3. 在手机浏览器(375x667)中测试
   - [ ] 弹窗占满大部分屏幕
   - [ ] 底部按钮垂直排列
   - [ ] 触控目标足够大
   - [ ] 可以正常滚动查看所有字段

---

### 测试场景8: 弹窗交互

**测试步骤:**

1. 打开问卷弹窗
2. 验证点:
   - [ ] 点击遮罩层关闭弹窗
   - [ ] 点击右上角✕按钮关闭弹窗
   - [ ] 按ESC键关闭弹窗(如已实现)
   - [ ] 关闭后表单数据重置
   - [ ] 再次打开时显示初始状态

3. 填写部分数据后关闭
4. 再次打开,验证点:
   - [ ] 表单数据已重置
   - [ ] 滑块回到默认值
   - [ ] 文本域为空

---

### 测试场景9: 数据提交

**测试步骤:**

1. 填写完整的问卷数据
2. 点击"提交"
3. 验证点:
   - [ ] 按钮显示"提交中..."
   - [ ] 按钮禁用,防止重复提交
   - [ ] 弹窗关闭
   - [ ] 聊天中添加AI回复消息
   - [ ] 回复内容根据问卷类型定制
   - [ ] 回复中包含用户填写的数据(如情绪评分)

4. 检查浏览器控制台
   - [ ] 控制台输出"问卷提交成功"日志
   - [ ] 显示提交的完整数据
   - [ ] 无错误信息

---

### 测试场景10: 边界情况

**测试步骤:**

1. 测试空内容消息:
   ```
   【emotion_assessment|】
   ```
   - [ ] 按钮文本为空时仍可渲染
   - [ ] 点击后仍能打开弹窗

2. 测试空问卷类型:
   ```
   
   【|填写问卷】
   ```
   - [ ] 问卷类型为空时,打开通用问卷或提示错误

3. 测试连续多个特殊标记:
   ```
   【emotion_assessment|情绪评估】【thought_record|认知记录】
   ```
   - [ ] 两个按钮都正确渲染
   - [ ] 点击每个按钮都能打开对应问卷

4. 测试特殊字符:
   ```
   【emotion_assessment|测试"特殊"字符!@#$%】
   ```
   - [ ] 按钮文本正确显示特殊字符
   - [ ] 特殊字符不影响功能

---

## 手动测试方法

### 方法1: 直接在聊天中测试

如果AI助手返回的消息中没有特殊标记,可以手动创建测试消息:

1. 打开浏览器开发者工具(F12)
2. 在Console中执行以下代码:

```javascript
// 模拟AI返回包含特殊标记的消息
const testMessage = {
  type: 'answer',
  content: '你好!为了了解你的情绪状态,请填写以下问卷:\n\n【emotion_assessment|填写情绪评估问卷】\n\n这只需要几分钟时间。'
}

// 获取Vue实例并添加到聊天列表
const app = document.querySelector('#app').__vueParentComponent.ctx
app.chatList.push(testMessage)
```

### 方法2: 修改后端Prompt

在后端prompt文件中添加测试用例,例如在 `holy7-express/prompts/default.md` 中:

```markdown
## 测试问卷功能

当用户说"测试问卷"时,返回以下内容:

你好!这是问卷功能测试:

【emotion_assessment|填写情绪评估问卷】
【thought_record|填写认知记录表】
【activity_plan|制定活动计划】

请选择一个问卷进行测试。
```

---

## 自动化测试建议

### 单元测试

建议为以下函数编写单元测试:

1. `parseSpecialTags()` - 特殊标记解析函数
2. `getMessageButtons()` - 获取消息按钮函数
3. `showQuestionnaireDialog()` - 显示问卷弹窗函数
4. `handleQuestionnaireSubmit()` - 处理问卷提交函数

### 组件测试

建议使用Vue Test Utils测试以下组件:

1. `QuestionnaireDialog.vue` - 问卷弹窗组件
2. `ChatMessages.vue` - 聊天消息组件(包含按钮渲染)

### E2E测试

建议使用Playwright或Cypress进行端到端测试:

1. 完整的问卷填写流程
2. 多个问卷按钮的交互
3. 响应式布局在不同设备的表现

---

## 已知问题和限制

1. **特殊标记格式严格**
   - 必须使用中文全角方括号
   - 不能有空格或换行在标记内部

2. **问卷类型匹配**
   - 必须与QuestionnaireDialog中定义的类型完全匹配
   - 不支持的类型会显示通用问卷

3. **数据持久化**
   - 当前版本问卷数据只显示在控制台
   - 未实现后端存储(可选功能)

---

## 测试检查清单

完成以下所有项目后,可认为功能测试通过:

### 基础功能
- [ ] 特殊标记正确解析
- [ ] 按钮正确渲染
- [ ] 点击按钮打开弹窗
- [ ] 弹窗显示正确的表单
- [ ] 表单验证正常工作
- [ ] 数据提交成功
- [ ] 提交后显示AI回复

### 5种问卷类型
- [ ] emotion_assessment (情绪评估)
- [ ] thought_record (认知记录表)
- [ ] activity_plan (活动计划表)
- [ ] problem_solving (问题解决工作表)
- [ ] mindfulness_breathing (正念呼吸练习)

### UI/UX
- [ ] 按钮样式美观
- [ ] 弹窗布局合理
- [ ] 响应式设计正常
- [ ] 交互动画流畅
- [ ] 表单字段清晰

### 边界情况
- [ ] 空内容处理
- [ ] 特殊字符处理
- [ ] 多个按钮处理
- [ ] 表单验证
- [ ] 错误处理

### 兼容性
- [ ] Chrome浏览器测试通过
- [ ] Firefox浏览器测试通过
- [ ] Safari浏览器测试通过
- [ ] 移动端测试通过

---

## 测试报告模板

```
测试日期: YYYY-MM-DD
测试人员: [姓名]
浏览器版本: [版本号]
测试环境: [开发/测试/生产]

测试结果:
通过场景: X/10
失败场景: Y/10
问题列表:
1. [问题描述]
2. [问题描述]

总体评价: [通过/需要修复/建议改进]

备注: [其他说明]
```

---

## 联系方式

如发现任何问题或有改进建议,请联系开发团队。
